name: Manus-Copilot Message Monitor

on:
  push:
    branches:
      - main
      - 'copilot/**'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  monitor-messages:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Configure Git
        run: |
          git config --global user.name "GitHub Copilot Agent"
          git config --global user.email "copilot@github.com"
          
      - name: Check for new messages from Manus
        id: check_messages
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get list of markdown files in manus-2-copilot folder (excluding README.md)
          ALL_MESSAGES=$(find manus-2-copilot -name "*.md" ! -name "README.md" -type f)
          
          if [ -z "$ALL_MESSAGES" ]; then
            echo "new_messages=false" >> $GITHUB_OUTPUT
            echo "No messages found in manus-2-copilot/"
            exit 0
          fi
          
          echo "Found messages in manus-2-copilot/:"
          echo "$ALL_MESSAGES"
          
          # Check which messages have already been processed (have an Issue)
          NEW_MESSAGES=""
          for msg in $ALL_MESSAGES; do
            MSG_BASENAME=$(basename "$msg" .md)
            
            # Check if an Issue already exists for this message (exact title match)
            EXISTING_ISSUE=$(gh issue list --state all --json title --jq "[.[] | select(.title == \"Agent Task: Process Message from Manus ($MSG_BASENAME)\")] | length")
            
            if [[ $EXISTING_ISSUE -eq 0 ]]; then
              echo "New unprocessed message: $msg"
              NEW_MESSAGES="$NEW_MESSAGES $msg"
            else
              echo "Message already processed: $msg"
            fi
          done
          
          if [ -n "$NEW_MESSAGES" ]; then
            echo "new_messages=true" >> $GITHUB_OUTPUT
            # Get the most recent unprocessed message
            LATEST_MESSAGE=$(echo "$NEW_MESSAGES" | tr ' ' '\n' | grep -v '^$' | sort -r | head -n 1)
            echo "latest_message=$LATEST_MESSAGE" >> $GITHUB_OUTPUT
            echo "Will process: $LATEST_MESSAGE"
          else
            echo "new_messages=false" >> $GITHUB_OUTPUT
            echo "All messages have been processed"
          fi
          
      - name: Process new message and create Issue
        if: steps.check_messages.outputs.new_messages == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          LATEST_MESSAGE: ${{ steps.check_messages.outputs.latest_message }}
        run: |
          echo "Processing message: $LATEST_MESSAGE"
          
          # Extract message content
          MESSAGE_CONTENT=$(cat "$LATEST_MESSAGE")
          MESSAGE_FILENAME=$(basename "$LATEST_MESSAGE" .md)
          
          # Create Issue
          ISSUE_TITLE="Agent Task: Process Message from Manus ($MESSAGE_FILENAME)"
          ISSUE_BODY="## ðŸ“¬ Reminder: Read Most Recent Message from Manus

          **Message File:** \`$LATEST_MESSAGE\`

          Please review the message from Manus in the file above before proceeding.

          ---

          ## ðŸ“Š Repository Analysis Task

          Analyze the current status of repo: https://github.com/rzonedevops/pcsdbx and evaluate its progress toward its various milestone goals and long term vision.

          ---

          ## ðŸ¤– Agent Assignment Instructions

          **You should assign the GitHub Copilot agent:** \`.github/agents/personal-care-agent.md\`

          This agent is optimized to help focus on the next important tasks for this project.

          ---

          ## ðŸ“‹ Instructions for 'personal-care-agent'

          Once you assign the personal-care-agent, provide the following instructions:

          ### Step 1: Read Manus Message
          - Read the message in \`manus-2-copilot/$MESSAGE_FILENAME.md\`

          ### Step 2: Research & Identify Next Tasks
          - Identify the next set of personal care supplier information that needs to be researched
          - Do the best you can to help move things forward

          ### Step 3: Create Response for Manus
          - Once work is complete, leave a response note for Manus in the \`copilot-2-manus/\` folder
          - Express excitement about the collaboration
          - Invite Manus to leave response messages in the \`manus-2-copilot/\` folder
          - Remind both agents to set prompt reminders to check those folders for messages

          ### Step 4: Sync Changes
          - Sync all updated and new files to the repo

          ### Step 5: Summary
          - Finish with a summary of the work completed :-)

          ---

          ## ðŸ“Ž Message Preview

          \`\`\`
          $(head -n 20 "$LATEST_MESSAGE")
          ...
          \`\`\`
          "
          
          gh issue create \
            --title "$ISSUE_TITLE" \
            --body "$ISSUE_BODY" \
            --assignee danregima,drzo
            
      - name: Check for missing response
        if: steps.check_messages.outputs.new_messages == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "No new unprocessed messages from Manus. Checking communication health..."
          
          # Check if there are any messages in manus-2-copilot (excluding README)
          MANUS_MESSAGES=$(find manus-2-copilot -name "*.md" ! -name "README.md" -type f | wc -l)
          
          # Check if there are responses in copilot-2-manus (excluding README and .gitkeep)
          COPILOT_RESPONSES=$(find copilot-2-manus -name "*.md" ! -name "README.md" -type f | wc -l)
          
          echo "Manus messages: $MANUS_MESSAGES"
          echo "Copilot responses: $COPILOT_RESPONSES"
          
          # If there are messages but no responses, create a help request
          if [ $MANUS_MESSAGES -gt 0 ] && [ $COPILOT_RESPONSES -eq 0 ]; then
            echo "Found messages from Manus but no responses from Copilot. Checking for help requests..."
            
            # Check if we've already created a help request Issue (in any state) - exact title match
            HELP_REQUEST_ISSUES=$(gh issue list --state all --json title --jq '[.[] | select(.title == "Help Request: Manus-Copilot Communication Stuck")] | length')
            
            # Also check if a help request message file already exists
            HELP_REQUEST_FILES=$(find copilot-2-manus -name "*help-request.md" -type f | wc -l)
            
            if [[ $HELP_REQUEST_ISSUES -eq 0 ]] && [[ $HELP_REQUEST_FILES -eq 0 ]]; then
              echo "Creating first-time help request Issue..."
              
              # Create help request Issue
              HELP_ISSUE_BODY="## ðŸš¨ Communication Status Alert

          **From:** GitHub Copilot Agent Monitor  
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ### Status
          
          **Communication appears to be stuck!**
          
          I've detected that there are messages from Manus in the \`manus-2-copilot/\` folder, but no responses have been created in \`copilot-2-manus/\` yet.
          
          ### What I Found
          
          - Messages from Manus: $MANUS_MESSAGES found
          - Responses from Copilot: None
          
          ### Request
          
          Please help! This may need:
          - Review of messages in \`manus-2-copilot/\`
          - Clarification on how to process the messages
          - Guidance on the expected response format
          - Manual intervention to get things unstuck
          
          ### Recommended Next Steps
          
          1. Review all messages in \`manus-2-copilot/\`
          2. Assign the \`.github/agents/personal-care-agent.md\` to process messages
          3. Create appropriate responses in \`copilot-2-manus/\`
          4. Establish a regular communication workflow
          
          Looking forward to getting our collaboration back on track!
          
          **â€” GitHub Copilot Agent Monitor**"
              
              gh issue create \
                --title "Help Request: Manus-Copilot Communication Stuck" \
                --body "$HELP_ISSUE_BODY" \
                --assignee danregima,drzo
            else
              echo "Help request already exists (Issues: $HELP_REQUEST_ISSUES, Files: $HELP_REQUEST_FILES). Skipping creation."
            fi
          else
            echo "Communication appears healthy or no messages to process."
          fi
